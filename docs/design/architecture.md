# VibeBox ç³»ç»Ÿæ¶æ„

**ç‰ˆæœ¬**: 1.1
**æ—¥æœŸ**: 2025-10-23
**çŠ¶æ€**: è‰ç¨¿
**ä½œè€…**: Fugen, Claude

**Tags:** #design:architecture #component:client #component:server #feature:mobile-first #feature:subscription #feature:authentication #feature:logto #feature:oauth #feature:payment #principle:zero-modification

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 æ„¿æ™¯

VibeBox æ˜¯ä¸€ä¸ª**ç§»åŠ¨ä¼˜å…ˆ**çš„ AI ç¼–ç å¹³å°ï¼Œæä¾›åŸºäºè®¢é˜…çš„ç¼–ç ç¯å¢ƒï¼ˆVibeBox å®ä¾‹ï¼‰ï¼Œé…å¤‡åŸç”Ÿç§»åŠ¨åº”ç”¨å’Œç½‘é¡µè®¿é—®ã€‚ç”¨æˆ·å¯ä»¥åœ¨ä»»ä½•åœ°ç‚¹ã€ä»»ä½•æ—¶é—´ä½¿ç”¨ AI è¾…åŠ©ç¼–ç ï¼Œæ— éœ€å¤æ‚é…ç½®ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼ä¸»å¼ 

- **ç§»åŠ¨ä¼˜å…ˆä½“éªŒ**: é’ˆå¯¹ç§»åŠ¨ç¼–ç åœºæ™¯ä¼˜åŒ–çš„åŸç”Ÿ iOS/Android åº”ç”¨
- **é›¶é…ç½®**: é¢„é…ç½® Claude Codeã€Happy CLI å’Œå¼€å‘å·¥å…·
- **æ— ç¼è®¿é—®**: è·¨æ‰€æœ‰å¹³å°çš„å•ä¸€ç»Ÿä¸€å®¢æˆ·ç«¯
- **è®¢é˜…åˆ¶**: æœˆä»˜/å¹´ä»˜è®¢é˜…ï¼ŒåŒ…å« Claude API é…é¢

### 1.3 æ ¸å¿ƒæ¶æ„åŸåˆ™

åŸºäº [CLAUDE.md](../../CLAUDE.md) å’Œ [ADR 001](../decisions/001-client-technology-stack.md)ï¼š

- **é›¶ä¿®æ”¹ > è‡ªå®šä¹‰æ–¹æ¡ˆ**: ä½¿ç”¨ Happy Server åŸç”Ÿ APIï¼Œä¸åšä¿®æ”¹
- **ä½“éªŒ > çº¯ç²¹æ€§**: å‰åç«¯åˆ†ç¦»æ˜¯åˆç†çš„æ¶æ„
- **æ§åˆ¶æƒ > ä¾èµ–**: ä¸ºå•†ä¸šéœ€æ±‚æä¾›æ·±åº¦å®šåˆ¶èƒ½åŠ›
- **ç§»åŠ¨ä¼˜å…ˆ**: React Native å®¢æˆ·ç«¯ä¸ºä¸»è¦å¹³å°ï¼ŒWeb ä¸ºè¾…åŠ©
- **ç®€å• > åŠŸèƒ½**: ä»ç®€å•è®¤è¯å¼€å§‹ï¼Œé€æ­¥æ¼”è¿›

**é›¶ä¿®æ”¹åŸåˆ™çš„å…·ä½“èŒƒå›´**:

VibeBox é¡¹ç›®éµå¾ª"é›¶ä¿®æ”¹"åŸåˆ™ï¼Œä½†ä»…é’ˆå¯¹æ ¸å¿ƒ Happy åŸºç¡€è®¾æ–½ï¼š

âœ… **ä¸ä¿®æ”¹çš„ç»„ä»¶** (Zero Modification):
- `happy-server`: å®Œå…¨ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬ï¼Œä¸ forkï¼Œä¸ä¿®æ”¹æºç 
- `happy-cli`: å®Œå…¨ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶é›†æˆ
- Happy åè®®å’Œ API: ä»…ä½¿ç”¨å®˜æ–¹å…¬å¼€çš„ APIï¼ˆ`/v1/auth`, `/v1/machines`, WebSocketï¼‰

âš ï¸ **éœ€è¦å®šåˆ¶çš„ç»„ä»¶** (Reasonable Customization):
- `happy-client`: Fork å¹¶å®šåˆ¶ï¼Œæ·»åŠ  VibeBox å•†ä¸šåŠŸèƒ½
  - åŸå› : éœ€è¦é›†æˆè®¢é˜…ç®¡ç†ã€æ”¯ä»˜æµç¨‹ã€VibeBox å®ä¾‹ç®¡ç†ç­‰å•†ä¸šåŠŸèƒ½
  - ç­–ç•¥: ä¿ç•™æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ˆç»ˆç«¯ã€ç¼–è¾‘å™¨ã€Claude Code é›†æˆã€åŠ å¯†ã€åŒæ­¥ï¼‰ï¼Œä»…æ·»åŠ å¹³å°ç‰¹å®š UI å’Œä¸šåŠ¡é€»è¾‘
--  - ç»´æŠ¤: å®šæœŸåˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼Œæœ€å°åŒ–å®šåˆ¶èŒƒå›´

è¿™ç§åˆ†ç¦»ç¬¦åˆ CLAUDE.md çš„æ ¸å¿ƒç†å¿µï¼š
- **é›¶ä¿®æ”¹**: ä¸æ”¹å˜ Happy åŸºç¡€è®¾æ–½å’Œåè®®
- **æ§åˆ¶æƒ > ä¾èµ–**: å¯¹å®¢æˆ·ç«¯ä½“éªŒæœ‰å®Œå…¨æ§åˆ¶æƒ
- **ä½“éªŒ > çº¯ç²¹æ€§**: ä¸ºç”¨æˆ·æä¾›å•†ä¸šçº§ä½“éªŒæ¯”ä¿æŒçº¯ç²¹çš„å¼€æºä½¿ç”¨æ›´é‡è¦

-

## 2. ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·è®¾å¤‡                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  iOS åŸç”Ÿåº”ç”¨   â”‚  â”‚ Android åŸç”Ÿ   â”‚  â”‚   Web æµè§ˆå™¨      â”‚  â”‚
â”‚  â”‚  (React Native)â”‚  â”‚ (React Native) â”‚  â”‚  (react-native-  â”‚  â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚   web)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    HTTPS/WebSocket
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VibeBox åç«¯                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Next.js 15 (App Router)                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  è®¤è¯ API     â”‚  â”‚  è®¢é˜…ç®¡ç†     â”‚  â”‚  VibeBox       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  è·¯ç”±        â”‚  â”‚  API è·¯ç”±     â”‚  â”‚  ç®¡ç† API      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         Happy é›†æˆæœåŠ¡                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - è´¦æˆ·åˆ›å»º (é€šè¿‡ /v1/auth)                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - èµ„æºæ± åˆ†é… (æœåŠ¡å™¨ + API Key)                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - è¿æ¥ä¿¡æ¯ç®¡ç†                                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
            â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL       â”‚ â”‚ Happy Server â”‚ â”‚  å¤–éƒ¨æœåŠ¡        â”‚
â”‚  æ•°æ®åº“            â”‚ â”‚ (å®˜æ–¹)       â”‚ â”‚  - æ”¯ä»˜æœåŠ¡      â”‚
â”‚  - ç”¨æˆ·           â”‚ â”‚ - /v1/auth   â”‚ â”‚    (å¾®ä¿¡/        â”‚
â”‚  - è®¢é˜…           â”‚ â”‚ - /v1/machinesâ”‚ â”‚     Stripe)     â”‚
â”‚  - VibeBoxes      â”‚ â”‚ - WebSocket  â”‚ â”‚  - é‚®ä»¶æœåŠ¡      â”‚
â”‚  - Happy æ˜ å°„     â”‚ â”‚              â”‚ â”‚                 â”‚
â”‚  - èµ„æºæ± çŠ¶æ€     â”‚ â”‚              â”‚ â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ ç”¨æˆ·è¿æ¥
                              â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚         èµ„æºæ± ï¼ˆé¢„é…ç½®ï¼‰          â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  ğŸ“¦ æœåŠ¡å™¨èµ„æºæ±                   â”‚
            â”‚  - é¢„è£… Happy å®ˆæŠ¤è¿›ç¨‹            â”‚
            â”‚  - é¢„è£… Claude Code              â”‚
            â”‚  - é¢„é…ç½®å¼€å‘ç¯å¢ƒ                 â”‚
            â”‚  - éšæ—¶å¯åˆ†é…                     â”‚
            â”‚                                  â”‚
            â”‚  ğŸ”‘ API Key èµ„æºæ±                 â”‚
            â”‚  - Claude API Keys               â”‚
            â”‚  - é¢„é…ç½®é…é¢                     â”‚
            â”‚  - éšæ—¶å¯åˆ†é…                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–²
                     â”‚ åˆ†é…ï¼ˆä¸æ¶‰åŠåˆ›å»ºï¼‰
                     â”‚
              VibeBox åç«¯ä»…è´Ÿè´£åˆ†é…
```

---

## 3. ç»„ä»¶æ¶æ„

### 3.1 å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰

**æŠ€æœ¯æ ˆ**: Expo SDK 54 + React Native 0.81 + React Native Web

**ç›®å½•ç»“æ„**:
```
client/sources/
â”œâ”€â”€ app/                          # Expo Router (åŸºäºæ–‡ä»¶çš„è·¯ç”±)
â”‚   â”œâ”€â”€ (auth)/                  # è®¤è¯æµç¨‹
â”‚   â”‚   â”œâ”€â”€ login.tsx            # ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ register.tsx         # æ³¨å†Œé¡µé¢
â”‚   â”‚   â””â”€â”€ _layout.tsx          # è®¤è¯å¸ƒå±€
â”‚   â”œâ”€â”€ (app)/                   # ä¸»åº”ç”¨ï¼ˆå—ä¿æŠ¤ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.tsx            # æ§åˆ¶å°/VibeBox åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ vibeboxes/           # VibeBox ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ [id].tsx         # VibeBox è¯¦æƒ…
â”‚   â”‚   â”‚   â””â”€â”€ connect.tsx      # è¿æ¥åˆ° Happy
â”‚   â”‚   â”œâ”€â”€ subscriptions/       # è®¢é˜…ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ plans.tsx        # è®¡åˆ’é€‰æ‹©
â”‚   â”‚   â”‚   â””â”€â”€ checkout.tsx     # æ”¯ä»˜æµç¨‹
â”‚   â”‚   â””â”€â”€ _layout.tsx          # åº”ç”¨å¸ƒå±€ï¼ˆå¸¦å¯¼èˆªï¼‰
â”‚   â””â”€â”€ _layout.tsx              # æ ¹å¸ƒå±€
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/                    # è®¤è¯ç»„ä»¶
â”‚   â”œâ”€â”€ vibebox/                 # VibeBox ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ VibeBoxCard.tsx      # å®ä¾‹å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ ConnectButton.tsx    # è¿æ¥åˆ° Happy æŒ‰é’®
â”‚   â”‚   â””â”€â”€ StatusIndicator.tsx  # çŠ¶æ€æ˜¾ç¤º
â”‚   â””â”€â”€ subscription/            # è®¢é˜…ç»„ä»¶
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api.ts                   # API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ auth.ts                  # è®¤è¯æœåŠ¡
â”‚   â””â”€â”€ vibebox.ts               # VibeBox æœåŠ¡
â””â”€â”€ store/                       # çŠ¶æ€ç®¡ç† (Zustand/Redux)
    â”œâ”€â”€ authStore.ts
    â””â”€â”€ vibeboxStore.ts
```

**å…³é”®è®¾è®¡å†³ç­–**:
- **åŸºäº happy-client**: ç›´æ¥ fork å’Œå®šåˆ¶ï¼Œç»§æ‰¿æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ˆç»ˆç«¯ã€ç¼–è¾‘å™¨ã€Claude Code é›†æˆã€åŠ å¯†ã€åŒæ­¥ï¼‰
- ä½¿ç”¨ Expo Router å®ç°åŸºäºæ–‡ä»¶çš„è·¯ç”±ï¼ˆç±»ä¼¼ Next.jsï¼‰
- ç®€å•çš„çŠ¶æ€ç®¡ç†ï¼ˆZustand æˆ– Context APIï¼‰
- é€šè¿‡é›†ä¸­å¼æœåŠ¡å±‚è°ƒç”¨ VibeBox å¹³å°åŠŸèƒ½çš„ API
- ä½¿ç”¨ token/secret è®¤è¯ç›´æ¥ WebSocket è¿æ¥åˆ° Happy Server

### 3.2 åç«¯ï¼ˆæœåŠ¡å™¨ï¼‰

**æŠ€æœ¯æ ˆ**: Next.js 15 + TypeScript + PostgreSQL

**ç›®å½•ç»“æ„**:
```
server/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ login/route.ts          # POST /api/auth/login
â”‚   â”‚   â”‚   â”œâ”€â”€ register/route.ts       # POST /api/auth/register
â”‚   â”‚   â”‚   â”œâ”€â”€ logout/route.ts         # POST /api/auth/logout
â”‚   â”‚   â”‚   â””â”€â”€ session/route.ts        # GET /api/auth/session
â”‚   â”‚   â”œâ”€â”€ subscriptions/
â”‚   â”‚   â”‚   â”œâ”€â”€ plans/route.ts          # GET /api/subscriptions/plans
â”‚   â”‚   â”‚   â”œâ”€â”€ checkout/route.ts       # POST /api/subscriptions/checkout
â”‚   â”‚   â”‚   â””â”€â”€ webhook/route.ts        # POST /api/subscriptions/webhook (æ”¯ä»˜å›è°ƒ)
â”‚   â”‚   â”œâ”€â”€ vibeboxes/
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts                # GET /api/vibeboxes (åˆ—è¡¨)
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/route.ts           # GET /api/vibeboxes/:id
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/connect/route.ts   # POST /api/vibeboxes/:id/connect
â”‚   â”‚   â”‚   â””â”€â”€ [id]/control/route.ts   # POST /api/vibeboxes/:id/control (å¯åŠ¨/åœæ­¢)
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â””â”€â”€ provision/route.ts      # POST /api/admin/provision (å†…éƒ¨)
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ auth.ts                         # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ db.ts                           # æ•°æ®åº“å®¢æˆ·ç«¯ (Prisma/Drizzle)
â”‚   â”œâ”€â”€ payment/                        # æ”¯ä»˜é›†æˆ
â”‚   â”‚   â”œâ”€â”€ types.ts                    # PaymentProvider æ¥å£
â”‚   â”‚   â”œâ”€â”€ paymentService.ts           # ä¸»æ”¯ä»˜æœåŠ¡
â”‚   â”‚   â””â”€â”€ providers/                  # æä¾›å•†å®ç°
â”‚   â”‚       â”œâ”€â”€ wechatPayProvider.ts    # å¾®ä¿¡æ”¯ä»˜
â”‚   â”‚       â”œâ”€â”€ stripeProvider.ts       # Stripe
â”‚   â”‚       â””â”€â”€ alipayProvider.ts       # æ”¯ä»˜å®
â”‚   â””â”€â”€ happy/
â”‚       â”œâ”€â”€ integration.ts              # HappyIntegration ç±»
â”‚       â”œâ”€â”€ ssh.ts                      # SSH è‡ªåŠ¨åŒ–
â”‚       â””â”€â”€ types.ts                    # Happy ç›¸å…³ç±»å‹
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ authService.ts                  # è®¤è¯ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ subscriptionService.ts          # è®¢é˜…é€»è¾‘
â”‚   â”œâ”€â”€ vibeboxService.ts               # VibeBox é…ç½®
â”‚   â””â”€â”€ happyService.ts                 # Happy é›†æˆ
â”œâ”€â”€ middleware.ts                        # è®¤è¯ä¸­é—´ä»¶
â””â”€â”€ prisma/                             # æ•°æ®åº“æ¨¡å¼
    â””â”€â”€ schema.prisma
```

**Service Layer Responsibilities**:

**HappyIntegration Service** (`lib/happy/integration.ts`)
- èŒè´£ï¼šHappy Serveré›†æˆå’Œè´¦æˆ·ç®¡ç†
- æ ¸å¿ƒèƒ½åŠ›ï¼š
  - åˆ›å»ºHappyè´¦æˆ·ï¼ˆç”Ÿæˆå¯†é’¥å¯¹ï¼Œè°ƒç”¨/v1/authï¼‰
  - è‡ªåŠ¨é…ç½®VibeBoxæœåŠ¡å™¨ï¼ˆSSH automationï¼‰
  - ç›‘æ§æœºå™¨è¿æ¥çŠ¶æ€

**VibeBoxService** (`services/vibeboxService.ts`)
- èŒè´£ï¼šVibeBoxå®ä¾‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ ¸å¿ƒèƒ½åŠ›ï¼š
  - VibeBoxå®ä¾‹é…ç½®ï¼ˆä»æ”¯ä»˜æˆåŠŸè§¦å‘ï¼‰
  - å®ä¾‹æ§åˆ¶ï¼ˆå¯åŠ¨ã€åœæ­¢ã€é‡å¯ï¼‰
  - èµ„æºæ± ç®¡ç†å’Œåˆ†é…
  - æä¾›è¿æ¥ä¿¡æ¯ï¼ˆtoken/secretï¼‰ç»™å®¢æˆ·ç«¯

**PaymentService** (`lib/payment/paymentService.ts`)
- èŒè´£ï¼šå¤šæ”¯ä»˜æä¾›å•†åè°ƒ
- æ ¸å¿ƒèƒ½åŠ›ï¼š
  - ç»Ÿä¸€è®¢å•åˆ›å»ºæ¥å£
  - Webhookå›è°ƒå¤„ç†å’ŒéªŒè¯
  - è®¢å•çŠ¶æ€æŸ¥è¯¢
  - æ”¯ä»˜æˆåŠŸåè§¦å‘VibeBoxé…ç½®

**Note**: VibeBoxå®¢æˆ·ç«¯ï¼ˆåŸºäºhappy-clientï¼‰ç›´æ¥é€šè¿‡WebSocketè¿æ¥åˆ°Happy Serverï¼Œä½¿ç”¨å­˜å‚¨åœ¨HappyAccountè¡¨ä¸­çš„token/secretè®¤è¯ã€‚

### 3.3 å¤–éƒ¨æœåŠ¡é›†æˆ

#### 3.3.1 Happy Serverï¼ˆå®˜æ–¹ï¼‰

**é›†æˆç«¯ç‚¹**:
- `/v1/auth` - è´¦æˆ·åˆ›å»ºï¼ˆæŒ‘æˆ˜-ç­¾åè®¤è¯ï¼‰
- `/v1/machines` - æœºå™¨æ³¨å†Œï¼ˆè‡ªåŠ¨ï¼‰
- WebSocket - å®æ—¶é€šä¿¡ï¼ˆæœªæ¥ï¼‰

**é›†æˆç­–ç•¥**: é›¶ä¿®æ”¹
- ä½¿ç”¨å®˜æ–¹ Happy Server API
- ä¸ forkï¼Œä¸ä¿®æ”¹
- åœ¨ VibeBox æ•°æ®åº“ä¸­æ˜ å°„è´¦æˆ·

#### 3.3.2 æ”¯ä»˜æœåŠ¡

**æ¶æ„**: æ’ä»¶åŒ–æ”¯ä»˜æä¾›å•†ç³»ç»Ÿï¼ˆè¯¦è§ç¬¬ 6.2 èŠ‚ï¼‰

**æ”¯æŒçš„æä¾›å•†**:
- **å¾®ä¿¡æ”¯ä»˜** - ä¸­å›½å¸‚åœºä¸»è¦æ–¹å¼ï¼ˆQR ç ã€åŸç”Ÿ APPï¼‰
- **Stripe** - å›½é™…å¸‚åœºä¸»è¦æ–¹å¼ï¼ˆCheckout Sessionï¼‰
- **æ”¯ä»˜å®** - ä¸­å›½å¸‚åœºè¾…åŠ©æ–¹å¼

**é€šç”¨é›†æˆç«¯ç‚¹**:
- è®¢å•åˆ›å»º - å¯åŠ¨æ”¯ä»˜æµç¨‹
- å›è°ƒ/Webhook - æ”¯ä»˜æˆåŠŸé€šçŸ¥
- è®¢å•çŠ¶æ€æŸ¥è¯¢ - æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
- è®¢å•å–æ¶ˆ - å¤„ç†é€€æ¬¾

**å…³é”® Webhook äº‹ä»¶**ï¼ˆè·¨æä¾›å•†æ ‡å‡†åŒ–ï¼‰:
- æ”¯ä»˜æˆåŠŸ - è§¦å‘ VibeBox é…ç½®
- è®¢é˜…ç»­è´¹ - å»¶é•¿è®¢é˜…å‘¨æœŸ
- è®¢é˜…å–æ¶ˆ - å¤„ç†å–æ¶ˆ

#### 3.3.3 é‚®ä»¶æœåŠ¡

**ä½¿ç”¨åœºæ™¯**:
- æ”¯æŒæ¸ é“ (support@vibebox.com)
- æ‰‹åŠ¨è®¢é˜…å–æ¶ˆï¼ˆMVPï¼‰
- æœªæ¥: å¼•å¯¼æµç¨‹ã€é€šçŸ¥

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 æ•°æ®åº“æ¨¡å¼

```prisma
// prisma/schema.prisma

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  username      String         @unique
  passwordHash  String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  subscriptions Subscription[]
  vibeBoxes     VibeBox[]
  happyAccount  HappyAccount?
}

model Subscription {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id])

  planId        String         // "basic" | "pro" | "enterprise"
  status        String         // "active" | "canceled" | "expired"

  // Payment provider info
  paymentProvider        String   // "wechat" | "stripe" | "alipay"
  paymentCustomerId      String?  // Provider's customer ID
  paymentSubscriptionId  String?  // Provider's subscription ID

  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId])
  @@index([paymentSubscriptionId])
}

model VibeBox {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id])

  // Server info (from resource pool)
  ip            String
  sshPort       Int            @default(22)
  rootPassword  String         // Encrypted

  // Resource pool allocation
  serverPoolId  String?        // ä»å“ªä¸ªæœåŠ¡å™¨æ± åˆ†é…çš„
  apiKeyId      String?        // åˆ†é…çš„ API Key ID
  allocatedAt   DateTime?      // èµ„æºåˆ†é…æ—¶é—´

  // Status
  status        String         // "allocated" | "running" | "stopped" | "terminated" | "error"

  // Plan
  planId        String

  // Happy integration
  happyConfigured Boolean      @default(true)  // èµ„æºæ± ä¸­çš„æœåŠ¡å™¨å·²é¢„é…ç½®

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId])
  @@index([serverPoolId])
  @@index([status])
}

model HappyAccount {
  id            String         @id @default(cuid())
  userId        String         @unique
  user          User           @relation(fields: [userId], references: [id])

  // Happy credentials (from Zero Modification Solution)
  happyToken    String
  happySecret   String         // Base64 encoded

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId])
}

model Plan {
  id            String         @id
  name          String         // "Basic" | "Pro" | "Enterprise"
  description   String

  // Pricing
  priceMonthly  Int            // In cents (e.g., 2900 = $29.00)
  priceYearly   Int            // In cents

  // Resources
  cpuCores      Int
  ramGb         Int
  diskGb        Int

  // API Quota
  claudeApiQuota Int           // In dollars (e.g., 10 = $10.00/month)

  // Features
  features      Json           // Array of feature strings

  active        Boolean        @default(true)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}
```

### 4.2 å®ä½“å…³ç³»

```
User (1) â”€â”€â”€ (0..1) HappyAccount
  â”‚
  â”œâ”€â”€â”€ (0..N) Subscription
  â”‚
  â””â”€â”€â”€ (0..N) VibeBox

Plan (1) â”€â”€â”€ (0..N) Subscription
```

---

## 5. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 5.1 ç”¨æˆ·å®Œæ•´æ—…ç¨‹

ä»ç”¨æˆ·æ³¨å†Œåˆ°å¼€å§‹ç¼–ç çš„å®Œæ•´æµç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ³¨å†Œ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. æäº¤é‚®ç®±ã€ç”¨æˆ·åã€å¯†ç 
     â”‚ 2. åç«¯éªŒè¯å¹¶åˆ›å»ºUserè®°å½•
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµè§ˆè®¡åˆ’ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 3. è·å–è®¢é˜…è®¡åˆ’åˆ—è¡¨
     â”‚    (Basic/Pro/Enterprise)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©è®¡åˆ’ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 4. é€‰æ‹©è®¡åˆ’å’Œä»˜è´¹å‘¨æœŸ
     â”‚    (æœˆä»˜/å¹´ä»˜)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”¯ä»˜æµç¨‹ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   â”‚
     â”‚ 5. é€‰æ‹©æ”¯ä»˜æ–¹å¼         â”‚ è¯¦è§ 5.3
     â”‚    - å¾®ä¿¡æ”¯ä»˜ (ä¸­å›½)    â”‚
     â”‚    - æ”¯ä»˜å® (ä¸­å›½)      â”‚
     â”‚    - Stripe (å›½é™…)      â”‚
     â”‚ 6. å®Œæˆæ”¯ä»˜            â”‚
     â–¼                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚æ”¯ä»˜æˆåŠŸ  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 7. Webhookè§¦å‘åç«¯å¤„ç†
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚VibeBox é…ç½®  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
      â”‚ 8. åˆ›å»ºHappyè´¦æˆ·      â”‚
      â”‚ 9. ä»èµ„æºæ± åˆ†é…æœåŠ¡å™¨  â”‚ è¯¦è§ 6.1 & 9.1
      â”‚10. ç»‘å®šAPI Key        â”‚
      â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚VibeBox å°±ç»ª  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚11. å®¢æˆ·ç«¯è·å–è¿æ¥ä¿¡æ¯
      â”‚    (token/secret)
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯è¿æ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚12. WebSocketè¿æ¥åˆ°Happy Server
       â”‚13. Happy Serverå…³è”åˆ°VibeBox
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼€å§‹ç¼–ç       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   - ç»ˆç«¯æ“ä½œ
   - æ–‡ä»¶ç¼–è¾‘
   - Claude Code å¯¹è¯
```

**å…³é”®æ—¶é—´èŠ‚ç‚¹**:
- æ³¨å†Œåˆ°ç™»å½•: <1ç§’
- æ”¯ä»˜æˆåŠŸåˆ°VibeBoxå°±ç»ª: <30ç§’ï¼ˆä»é¢„é…ç½®èµ„æºæ± åˆ†é…ï¼‰
- VibeBoxå°±ç»ªåˆ°å®¢æˆ·ç«¯è¿æ¥: <5ç§’

### 5.2 VibeBoxç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     [æ”¯ä»˜æˆåŠŸ]                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   allocated     â”‚ â† ä»èµ„æºæ± åˆ†é…ï¼ˆæœåŠ¡å™¨ + API Keyï¼‰
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ ç»‘å®šç”¨æˆ·è´¦æˆ·
                    â”‚ èµ„æºå·²é¢„é…ç½®ï¼Œæ— éœ€å®‰è£…
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”Œâ”€â”€â”€â†’â”‚    running      â”‚â—„â”€â”€â”
       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
       â”‚            â”‚              â”‚
       â”‚  [å¯åŠ¨]    â”‚  [åœæ­¢]      â”‚  [é‡å¯]
       â”‚            â–¼              â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
       â””â”€â”€â”€â”€â”¤    stopped      â”œâ”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ [è®¢é˜…è¿‡æœŸ/å–æ¶ˆ]
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   terminated    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            [é‡Šæ”¾èµ„æºï¼Œå½’è¿˜èµ„æºæ± ]

        [ä»»ä½•çŠ¶æ€å‡ºé”™]
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     error       â”‚ â†’ äººå·¥ä»‹å…¥/è‡ªåŠ¨é‡è¯•
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è¯´æ˜**:
- **allocated**: å·²ä»èµ„æºæ± åˆ†é…æœåŠ¡å™¨å’ŒAPI Keyï¼ˆèµ„æºé¢„é…ç½®ï¼Œç«‹å³å¯ç”¨ï¼‰
- **running**: VibeBoxæ­£å¸¸è¿è¡Œï¼Œç”¨æˆ·å¯è¿æ¥ä½¿ç”¨
- **stopped**: å·²åœæ­¢ï¼Œå¯é‡æ–°å¯åŠ¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
- **terminated**: å·²ç»ˆæ­¢ï¼Œèµ„æºå·²é‡Šæ”¾å¹¶å½’è¿˜èµ„æºæ± 
- **error**: åˆ†é…æˆ–è¿è¡Œå‡ºé”™ï¼Œéœ€è¦å¤„ç†

**çŠ¶æ€è½¬æ¢è§¦å‘**:
- æ”¯ä»˜æˆåŠŸ: allocated â†’ runningï¼ˆè‡ªåŠ¨ï¼‰
- ç”¨æˆ·æ“ä½œ: å¯åŠ¨/åœæ­¢/é‡å¯æŒ‰é’®
- ç³»ç»Ÿäº‹ä»¶: è®¢é˜…è¿‡æœŸã€åˆ†é…å¤±è´¥
- è‡ªåŠ¨åŒ–: èµ„æºå›æ”¶ã€å¥åº·æ£€æŸ¥å¤±è´¥

**å…³é”®ä¼˜åŒ–**:
- âœ… å»æ‰äº† provisioning å’Œ configuring çŠ¶æ€ï¼ˆèµ„æºæ± é¢„é…ç½®ï¼‰
- âœ… allocated â†’ running ç¬é—´å®Œæˆï¼ˆ<30ç§’ï¼‰
- âœ… terminated åèµ„æºå½’è¿˜æ± ï¼ˆå¯é‡å¤åˆ©ç”¨ï¼‰

### 5.3 æ”¯ä»˜åˆ°é…ç½®æµç¨‹ï¼ˆè¯¦ç»†æ—¶åºï¼‰

```
ç”¨æˆ·å®¢æˆ·ç«¯          VibeBoxåç«¯         æ”¯ä»˜æä¾›å•†       Happy Server      èµ„æºæ± 
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 1. é€‰æ‹©è®¡åˆ’        â”‚                   â”‚                â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 2. åˆ›å»ºè®¢å•è¯·æ±‚    â”‚                   â”‚                â”‚                â”‚
    â”‚   (planId, provider)                  â”‚                â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚ 3. è°ƒç”¨Provider    â”‚                â”‚                â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
    â”‚                   â”‚ 4. è¿”å›æ”¯ä»˜ä¿¡æ¯    â”‚                â”‚                â”‚
    â”‚                   â”‚   (QRç /URL)      â”‚                â”‚                â”‚
    â”‚   5. è¿”å›æ”¯ä»˜ä¿¡æ¯  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 6. å±•ç¤ºQRç /æ‰“å¼€URLâ”‚                   â”‚                â”‚                â”‚
    â”‚ 7. å®Œæˆæ”¯ä»˜        â”‚                   â”‚                â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚ 8. Webhookå›è°ƒ    â”‚                â”‚                â”‚
    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
    â”‚                   â”‚ 9. éªŒè¯ç­¾å        â”‚                â”‚                â”‚
    â”‚                   â”‚10. æ›´æ–°è®¢é˜…çŠ¶æ€    â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚11. è§¦å‘VibeBoxé…ç½® â”‚                â”‚                â”‚
    â”‚                   â”‚    [å¼‚æ­¥ä»»åŠ¡]      â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚12. ç”Ÿæˆå¯†é’¥å¯¹      â”‚                â”‚                â”‚
    â”‚                   â”‚13. è°ƒç”¨/v1/auth    â”‚                â”‚                â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
    â”‚                   â”‚14. è¿”å›token       â”‚                â”‚                â”‚
    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚15. ä»èµ„æºæ± åˆ†é…    â”‚                â”‚                â”‚
    â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                   â”‚    - é€‰æ‹©å¯ç”¨æœåŠ¡å™¨â”‚                â”‚                â”‚
    â”‚                   â”‚    - é€‰æ‹©å¯ç”¨API Key                â”‚                â”‚
    â”‚                   â”‚16. è¿”å›èµ„æºä¿¡æ¯    â”‚                â”‚                â”‚
    â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                   â”‚    (IP, å‡­è¯, API Key)              â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚                   â”‚17. ç»‘å®šèµ„æºåˆ°ç”¨æˆ·  â”‚                â”‚                â”‚
    â”‚                   â”‚18. æ›´æ–°VibeBoxçŠ¶æ€ â”‚                â”‚                â”‚
    â”‚                   â”‚    (running)      â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 19. è½®è¯¢çŠ¶æ€       â”‚                   â”‚                â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                â”‚                â”‚
    â”‚ 20. è¿”å›å°±ç»ª       â”‚                   â”‚                â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 21. è·å–è¿æ¥ä¿¡æ¯   â”‚                   â”‚                â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                â”‚                â”‚
    â”‚ 22. è¿”å›token/secret                  â”‚                â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                â”‚                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 23. WebSocketè¿æ¥  â”‚                   â”‚                â”‚                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
    â”‚ 24. è®¤è¯å¹¶å…³è”machine                 â”‚                â”‚                â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
    â”‚                   â”‚                   â”‚                â”‚                â”‚
    â”‚ 25. å¼€å§‹ä½¿ç”¨       â”‚                   â”‚                â”‚                â”‚
```

**å…³é”®æ­¥éª¤è¯´æ˜**:

1. **æ”¯ä»˜é˜¶æ®µ** (æ­¥éª¤1-7):
   - ç”¨æˆ·é€‰æ‹©è®¡åˆ’ï¼Œåç«¯åˆ›å»ºæ”¯ä»˜è®¢å•
   - è¿”å›æ”¯ä»˜æ–¹å¼ç›¸å…³ä¿¡æ¯ï¼ˆå¾®ä¿¡QRç /Stripe URLï¼‰
   - ç”¨æˆ·å®Œæˆæ”¯ä»˜

2. **Webhookå¤„ç†** (æ­¥éª¤8-10):
   - æ”¯ä»˜æä¾›å•†å¼‚æ­¥å›è°ƒ
   - éªŒè¯ç­¾åç¡®ä¿å®‰å…¨æ€§
   - æ›´æ–°è®¢é˜…çŠ¶æ€ä¸ºactive

3. **VibeBoxé…ç½®** (æ­¥éª¤11-18):
   - å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç†ï¼ˆé¿å…é˜»å¡webhookå“åº”ï¼‰
   - åˆ›å»ºHappyè´¦æˆ·ï¼ˆå¯†é’¥å¯¹ç”Ÿæˆ + /v1/authè°ƒç”¨ï¼‰
   - **ä»èµ„æºæ± åˆ†é…é¢„é…ç½®èµ„æº**ï¼ˆæœåŠ¡å™¨ + API Keyï¼‰
   - ç»‘å®šèµ„æºåˆ°ç”¨æˆ·è´¦æˆ·
   - æ— éœ€SSHé…ç½®ï¼Œèµ„æºå·²é¢„é…ç½®å®Œæ¯•

4. **å®¢æˆ·ç«¯è¿æ¥** (æ­¥éª¤19-25):
   - å®¢æˆ·ç«¯è½®è¯¢VibeBoxçŠ¶æ€ç›´åˆ°å°±ç»ª
   - è·å–token/secretè¿æ¥ä¿¡æ¯
   - ç›´æ¥WebSocketè¿æ¥Happy Server
   - å¼€å§‹ç¼–ç 

**æ—¶é—´ä¼°ç®—**:
- æ”¯ä»˜ç¡®è®¤: å®æ—¶ - 30ç§’
- Webhookå›è°ƒ: <10ç§’
- VibeBoxé…ç½®: <30ç§’ï¼ˆèµ„æºæ± åˆ†é…ï¼Œæ— éœ€å®‰è£…é…ç½®ï¼‰
- å®¢æˆ·ç«¯è¿æ¥: <5ç§’

**å…³é”®ä¼˜åŒ–**:
- âœ… å»æ‰äº†SSHè¿æ¥å’Œé…ç½®æ­¥éª¤ï¼ˆæ­¥éª¤15-17ï¼‰
- âœ… èµ„æºæ± é¢„é…ç½®ï¼Œåˆ†é…å³å¯ç”¨
- âœ… æ€»æ—¶é—´ä»2-5åˆ†é’Ÿç¼©çŸ­åˆ°<30ç§’

---

## 6. é›†æˆè¯¦æƒ…

### 6.1 Happy Server é›†æˆ

**åŸºäº**: [é›¶ä¿®æ”¹æ–¹æ¡ˆ](../implementation/zero-modification-solution.md)

#### é›†æˆæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VibeBoxåç«¯   â”‚         â”‚ Happy Server â”‚         â”‚ èµ„æºæ±         â”‚
â”‚              â”‚         â”‚   (å®˜æ–¹)      â”‚         â”‚ (é¢„é…ç½®æœåŠ¡å™¨)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚
       â”‚ 1. åˆ›å»ºè´¦æˆ·             â”‚                        â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
       â”‚   POST /v1/auth        â”‚                        â”‚
       â”‚   {publicKey,          â”‚                        â”‚
       â”‚    challenge,          â”‚                        â”‚
       â”‚    signature}          â”‚                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚ 2. è¿”å›token           â”‚                        â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚ 3. å­˜å‚¨åˆ°æ•°æ®åº“         â”‚                        â”‚
       â”‚   HappyAccountè¡¨       â”‚                        â”‚
       â”‚   {token, secret}      â”‚                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚ 4. ä»èµ„æºæ± åˆ†é…         â”‚                        â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚   - é€‰æ‹©å¯ç”¨æœåŠ¡å™¨      â”‚                        â”‚
       â”‚   - é€‰æ‹©å¯ç”¨API Key     â”‚                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚ 5. è¿”å›èµ„æºä¿¡æ¯         â”‚                        â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚   {ip, port, password, â”‚                        â”‚
       â”‚    apiKey}             â”‚                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚ 6. ç»‘å®šèµ„æºåˆ°ç”¨æˆ·       â”‚                        â”‚
       â”‚   VibeBoxè¡¨            â”‚                        â”‚
       â”‚   çŠ¶æ€: running        â”‚                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚                        â”‚   æœºå™¨å·²æ³¨å†Œ            â”‚
       â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                        â”‚   (èµ„æºæ± é¢„é…ç½®æ—¶)      â”‚
       â”‚                        â”‚   /v1/machines         â”‚
       â”‚                        â”‚                        â”‚
```

#### å…³é”®æµç¨‹è¯´æ˜

**æ­¥éª¤1ï¼šHappyè´¦æˆ·åˆ›å»ºï¼ˆå‘ç”Ÿåœ¨æ”¯ä»˜æˆåŠŸåï¼‰**

ç›®çš„ï¼šä¸ºç”¨æˆ·åˆ›å»ºHappyå¹³å°è´¦æˆ·ï¼Œç”¨äºåç»­è¿æ¥è®¤è¯

- åç«¯ç”ŸæˆEd25519å¯†é’¥å¯¹ï¼ˆ32å­—èŠ‚éšæœºsecretï¼‰
- ä½¿ç”¨å¯†é’¥å¯¹ç”Ÿæˆç­¾å
- è°ƒç”¨Happy Serverçš„ `/v1/auth` APIè¿›è¡ŒæŒ‘æˆ˜-ç­¾åè®¤è¯
- è·å¾—Happyå¹³å°çš„è®¤è¯token
- å°†tokenå’Œsecretå­˜å‚¨åˆ°æ•°æ®åº“ `HappyAccount` è¡¨
- **å…³é”®**: ä¸€ä¸ªVibeBoxå¹³å°ç”¨æˆ· å¯¹åº” ä¸€ä¸ªHappyè´¦æˆ·ï¼ˆ1:1æ˜ å°„ï¼‰

**Token æœ‰æ•ˆæœŸç­–ç•¥**ï¼š
- âœ… **æ°¸ä¹…æœ‰æ•ˆ**ï¼šHappy Server ä½¿ç”¨ `PersistentToken`ï¼ˆæŒä¹…åŒ–ä»¤ç‰Œï¼‰ï¼Œæ— è¿‡æœŸæ—¶é—´
- âœ… **æ— éœ€åˆ·æ–°**ï¼šä¸€æ¬¡æ€§åˆ›å»ºï¼Œé•¿æœŸä½¿ç”¨
- âœ… **ç®€åŒ–æ¶æ„**ï¼šæ— éœ€å®ç° token åˆ·æ–°æœºåˆ¶å’Œè¿‡æœŸæ£€æµ‹
- âš ï¸ **æ’¤é”€æœºåˆ¶**ï¼šå¦‚æœéœ€è¦æ’¤é”€ç”¨æˆ·è®¿é—®æƒé™ï¼Œå¯è°ƒç”¨ Happy Server çš„ `invalidateUserTokens` APIï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·ä¸»åŠ¨æ³¨é”€ã€å®‰å…¨äº‹ä»¶å“åº”ï¼‰

**æ­¥éª¤2ï¼šä»èµ„æºæ± åˆ†é…èµ„æº**

ç›®çš„ï¼šä¸ºç”¨æˆ·åˆ†é…é¢„é…ç½®çš„ VibeBox èµ„æº

- ä»æœåŠ¡å™¨èµ„æºæ± ä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨
  - æœåŠ¡å™¨å·²é¢„è£… Happy å®ˆæŠ¤è¿›ç¨‹
  - æœåŠ¡å™¨å·²é¢„è£… Claude Code
  - æœåŠ¡å™¨å·²é¢„é…ç½®å¼€å‘ç¯å¢ƒ
  - Happy å®ˆæŠ¤è¿›ç¨‹å·²å‘ Happy Server æ³¨å†Œ
- ä» API Key èµ„æºæ± ä¸­é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ Claude API Key
- è¿”å›èµ„æºä¿¡æ¯ï¼ˆIPã€ç«¯å£ã€rootå¯†ç ã€API Keyï¼‰
- ç»‘å®šèµ„æºåˆ°ç”¨æˆ·è´¦æˆ·
- æ›´æ–° VibeBox çŠ¶æ€ä¸º running

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… **å³æ—¶å¯ç”¨**ï¼šèµ„æºå·²é¢„é…ç½®ï¼Œæ— éœ€ç­‰å¾…å®‰è£…
- âœ… **ç®€åŒ–æ¶æ„**ï¼šä¸éœ€è¦ SSH è‡ªåŠ¨åŒ–é€»è¾‘
- âœ… **å¿«é€Ÿåˆ†é…**ï¼š<30ç§’å®Œæˆæ•´ä¸ªæµç¨‹

**æ­¥éª¤3ï¼šå®¢æˆ·ç«¯è¿æ¥ï¼ˆç›´æ¥WebSocketï¼‰**

ç›®çš„ï¼šVibeBoxå®¢æˆ·ç«¯é€šè¿‡Happy Serverè¿æ¥åˆ°ç”¨æˆ·çš„VibeBox

- å®¢æˆ·ç«¯ä»åç«¯APIè·å–è¿æ¥ä¿¡æ¯ï¼ˆtoken/secretï¼‰
- ä½¿ç”¨happy-clientå†…ç½®çš„è¿æ¥é€»è¾‘
- ç›´æ¥é€šè¿‡WebSocketè¿æ¥åˆ°Happy Server (`wss://api.happy.dev`)
- Happy Serveræ ¹æ®tokenè¯†åˆ«ç”¨æˆ·ï¼Œå…³è”åˆ°å·²æ³¨å†Œçš„VibeBoxæœºå™¨
- å»ºç«‹ç«¯åˆ°ç«¯åŠ å¯†é€šé“
- å®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œç»ˆç«¯å‘½ä»¤ã€æ–‡ä»¶æ“ä½œã€Claude Codeå¯¹è¯

#### å®‰å…¨è€ƒè™‘

**å¯†é’¥ç®¡ç†**:
- Happy secretå­˜å‚¨æ—¶ç»è¿‡åŠ å¯†ï¼ˆAES-256ï¼‰
- æ•°æ®åº“ä¸­çš„secretå­—æ®µä¸ºåŠ å¯†åçš„å€¼
- ä¼ è¾“è¿‡ç¨‹ä½¿ç”¨HTTPS/TLSåŠ å¯†

**èµ„æºæ± å®‰å…¨**:
- æœåŠ¡å™¨rootå¯†ç åŠ å¯†å­˜å‚¨
- API KeyåŠ å¯†å­˜å‚¨
- èµ„æºåˆ†é…æ—¶è¿›è¡Œè®¿é—®æƒé™éªŒè¯
- èµ„æºå½’è¿˜æ—¶æ¸…ç†ç”¨æˆ·æ•°æ®ï¼ˆå¯é€‰ç­–ç•¥ï¼‰

**Tokenå®‰å…¨**:
- tokenç”±Happy Serverç”Ÿæˆï¼Œä¸å¯é¢„æµ‹
- tokenä¸ç”¨æˆ·è´¦æˆ·ç»‘å®šï¼Œæ— æ³•è·¨ç”¨æˆ·ä½¿ç”¨
- å®¢æˆ·ç«¯å­˜å‚¨tokenæ—¶ä½¿ç”¨secure storage

#### é›¶ä¿®æ”¹åŸåˆ™å®ç°

**é›¶ä¿®æ”¹èŒƒå›´** (ä¸ Section 1.3 ä¸€è‡´):

æœ¬æ–¹æ¡ˆä¸¥æ ¼éµå¾ªé›¶ä¿®æ”¹åŸåˆ™ï¼Œä»…é’ˆå¯¹ Happy æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼š

âœ… **å®Œå…¨ä¸ä¿®æ”¹çš„ç»„ä»¶**:
- `happy-server`: ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬å’Œ Docker é•œåƒ
- `happy-cli`: ä½¿ç”¨å®˜æ–¹ npm åŒ…
- Happy åè®®: ä»…ä½¿ç”¨å®˜æ–¹å…¬å¼€ API

**ä½¿ç”¨çš„å®˜æ–¹API**:
- `/v1/auth` - æ ‡å‡†çš„æŒ‘æˆ˜-ç­¾åè®¤è¯ï¼Œè‡ªåŠ¨åˆ›å»ºè´¦æˆ·
- `/v1/machines` - æœºå™¨è‡ªåŠ¨æ³¨å†Œ
- WebSocket - æ ‡å‡†è¿æ¥åè®®ï¼Œç«¯åˆ°ç«¯åŠ å¯†

**æˆ‘ä»¬ä¸åšçš„äº‹ï¼ˆZero Modificationï¼‰**:
- âŒ ä¸ä¿®æ”¹ happy-server æºç æˆ–æ•°æ®åº“ schema
- âŒ ä¸ fork happy-server æˆ– happy-cli é¡¹ç›®
- âŒ ä¸ä¾èµ– Happy éå…¬å¼€ API æˆ–å†…éƒ¨å®ç°ç»†èŠ‚
- âŒ ä¸ä¿®æ”¹ Happy åè®®æˆ–é€šä¿¡æ ¼å¼
- âœ… å®Œå…¨åŸºäºå®˜æ–¹æ–‡æ¡£çš„å…¬å¼€ API å’Œæ ‡å‡†é…ç½®

**å®¢æˆ·ç«¯å®šåˆ¶è¯´æ˜**:

VibeBox å®¢æˆ·ç«¯æ˜¯ happy-client çš„**ç›´æ¥ fork å’Œåˆç†å®šåˆ¶**ï¼ˆéåŒ…è£…å™¨æˆ–å¤–å£³ï¼‰ã€‚è¿™ç§å®šåˆ¶æ˜¯åˆç†çš„ï¼Œå› ä¸ºï¼š

1. **ç¬¦åˆ"æ§åˆ¶æƒ > ä¾èµ–"åŸåˆ™**: å•†ä¸šäº§å“éœ€è¦å¯¹ç”¨æˆ·ä½“éªŒæœ‰å®Œå…¨æ§åˆ¶æƒ
2. **ç¬¦åˆ"ä½“éªŒ > çº¯ç²¹æ€§"åŸåˆ™**: ä¸ºç”¨æˆ·æä¾›å•†ä¸šçº§ä½“éªŒæ¯”ä¿æŒçº¯ç²¹çš„å¼€æºä½¿ç”¨æ›´é‡è¦
3. **ä¸è¿åé›¶ä¿®æ”¹åŸåˆ™**: é›¶ä¿®æ”¹ä»…é€‚ç”¨äº Happy åŸºç¡€è®¾æ–½ï¼ˆserver/cliï¼‰ï¼Œä¸åŒ…æ‹¬å®¢æˆ·ç«¯ UI

âœ… **å®Œæ•´åŠŸèƒ½ç»§æ‰¿**:
- å®Œæ•´çš„ç»ˆç«¯æ¨¡æ‹Ÿå™¨ï¼ˆæ¥è‡ª happy-clientï¼‰
- å¸¦è¯­æ³•é«˜äº®çš„ä»£ç ç¼–è¾‘å™¨ï¼ˆæ¥è‡ª happy-clientï¼‰
- Claude Code é›†æˆï¼ˆæ¥è‡ª happy-clientï¼‰
- å®æ—¶åŒæ­¥å’ŒåŠ å¯†ï¼ˆæ¥è‡ª happy-clientï¼‰
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆæ¥è‡ª happy-clientï¼‰

âœ… **æ–°å¢å•†ä¸šåŠŸèƒ½**:
- è®¢é˜…ç®¡ç† UIï¼ˆLogto é›†æˆï¼‰
- æ”¯ä»˜æµç¨‹é›†æˆï¼ˆå¤šæ”¯ä»˜æä¾›å•†ï¼‰
- VibeBox å®ä¾‹ç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢/é‡å¯ï¼‰
- å¹³å°è´¦æˆ·ç³»ç»Ÿï¼ˆç”¨æˆ· Dashboardï¼‰

âœ… **å•ä¸€ç»Ÿä¸€å®¢æˆ·ç«¯**:
- ç”¨æˆ·ä¸ä¼šç¦»å¼€ VibeBox åº”ç”¨
- æ—  WebView åµŒå…¥æˆ–å¤–éƒ¨ç½‘é¡µ
- å…¨ç¨‹åŸç”Ÿç§»åŠ¨ä½“éªŒ
- ç›´æ¥ WebSocket è¿æ¥åˆ° Happy Serverï¼ˆä¸ happy-cli ç›¸åŒåè®®ï¼‰

âŒ **æˆ‘ä»¬ä¸åšçš„äº‹**:
- ~~åµŒå…¥ Happy çš„ web ç•Œé¢ (web.happy.dev)~~
- ~~ç”Ÿæˆ web URL ä¾›ç”¨æˆ·è®¿é—®~~
- ~~æ·±åº¦é“¾æ¥åˆ°å¤–éƒ¨åº”ç”¨~~
- ~~OAuth é‡å®šå‘åˆ° Happy çš„è®¤è¯~~

**æŠ€æœ¯å®ç°**:
å®¢æˆ·ç«¯ä½¿ç”¨ä¸ happy-cli å’Œ happy-web ç›¸åŒçš„åè®®ç›´æ¥è¿æ¥åˆ° Happy Serverï¼Œä½¿ç”¨ä» VibeBox åç«¯è·å–çš„ token/secret è¿›è¡Œè®¤è¯ï¼Œä½†æä¾›åŸç”Ÿç§»åŠ¨ UI è€Œé web ç•Œé¢ã€‚

---

### 6.2 æ”¯ä»˜é›†æˆ

**æ¶æ„è®¾è®¡**: æ’ä»¶åŒ–æ”¯ä»˜æä¾›å•†ç³»ç»Ÿï¼Œæ”¯æŒå¤šå¸‚åœºå¤šæ”¯ä»˜æ–¹å¼

#### æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PaymentService                         â”‚
â”‚              (ç»Ÿä¸€æ”¯ä»˜æœåŠ¡åè°ƒå±‚)                         â”‚
â”‚                                                         â”‚
â”‚  - createOrder(provider, params)                        â”‚
â”‚  - handleCallback(provider, request)                    â”‚
â”‚  - queryOrderStatus(orderId)                            â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚           â”‚            â”‚
             â–¼           â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  WeChat    â”‚ â”‚  Stripe    â”‚ â”‚  Alipay    â”‚
    â”‚  Provider  â”‚ â”‚  Provider  â”‚ â”‚  Provider  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼
    å¾®ä¿¡æ”¯ä»˜API    Stripe API     æ”¯ä»˜å®API
    - QRç æ”¯ä»˜    - Checkout     - QRç æ”¯ä»˜
    - APPæ”¯ä»˜     - Webhook      - APPæ”¯ä»˜
```

#### è®¾è®¡è¦æ±‚

**å¤šå¸‚åœºæ”¯æŒ**:
- **ä¸­å›½å¸‚åœº**ï¼šå¾®ä¿¡æ”¯ä»˜ï¼ˆä¸»ï¼‰ã€æ”¯ä»˜å®ï¼ˆè¾…ï¼‰
  - æ”¯ä»˜æ–¹å¼ï¼šQRç æ‰«ç ã€APPå†…æ”¯ä»˜
  - è´§å¸ï¼šäººæ°‘å¸ï¼ˆCNYï¼‰
  - åˆè§„ï¼šç¬¦åˆä¸­å›½æ”¯ä»˜ç›‘ç®¡è¦æ±‚

- **å›½é™…å¸‚åœº**ï¼šStripeï¼ˆä¸»ï¼‰
  - æ”¯ä»˜æ–¹å¼ï¼šä¿¡ç”¨å¡ã€å€Ÿè®°å¡
  - è´§å¸ï¼šç¾å…ƒï¼ˆUSDï¼‰ã€æ¬§å…ƒï¼ˆEURï¼‰ç­‰
  - åˆè§„ï¼šPCI-DSSè®¤è¯

**æ’ä»¶åŒ–æ¶æ„**:
- æ¯ä¸ªæ”¯ä»˜æä¾›å•†å®ç°ç»Ÿä¸€æ¥å£
- æ ¸å¿ƒèƒ½åŠ›ï¼š
  - **åˆ›å»ºè®¢å•**ï¼šæ ¹æ®è®¡åˆ’å’Œç”¨æˆ·åˆ›å»ºæ”¯ä»˜è®¢å•
  - **å¤„ç†å›è°ƒ**ï¼šæ¥æ”¶æ”¯ä»˜æˆåŠŸé€šçŸ¥ï¼ˆWebhookï¼‰
  - **æŸ¥è¯¢çŠ¶æ€**ï¼šä¸»åŠ¨æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€
  - **å–æ¶ˆé€€æ¬¾**ï¼šå¤„ç†è®¢å•å–æ¶ˆå’Œé€€æ¬¾è¯·æ±‚

- æä¾›å•†ç‰¹å®šç»†èŠ‚å°è£…åœ¨å„è‡ªå®ç°ä¸­
- æ·»åŠ æ–°æ”¯ä»˜æ–¹å¼æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘

#### æ”¯ä»˜æµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·é€‰æ‹©è®¡åˆ’â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åç«¯åˆ›å»ºæ”¯ä»˜è®¢å•   â”‚ â† PaymentService.createOrder()
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ è°ƒç”¨å¯¹åº”Provider
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¿”å›æ”¯ä»˜ä¿¡æ¯       â”‚
â”‚ - QRç URL (å¾®ä¿¡) â”‚
â”‚ - Checkout URL   â”‚
â”‚   (Stripe)       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·å®Œæˆæ”¯ä»˜       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ”¯ä»˜æä¾›å•†Webhook  â”‚ â† å¼‚æ­¥å›è°ƒåç«¯
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚éªŒè¯ç­¾å           â”‚ â† Provider.handleCallback()
â”‚è§£ææ”¯ä»˜ç»“æœ       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ›´æ–°è®¢é˜…çŠ¶æ€       â”‚ â† status = 'active'
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è§¦å‘VibeBoxé…ç½®    â”‚ â† å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®æŠ€æœ¯è¦æ±‚

**å®‰å…¨æ€§**:
- Webhookç­¾åéªŒè¯ï¼ˆé˜²ä¼ªé€ å›è°ƒï¼‰
- HTTPSä¼ è¾“åŠ å¯†
- è®¢å•å¹‚ç­‰æ€§å¤„ç†ï¼ˆé˜²é‡å¤å¤„ç†ï¼‰
- æ”¯ä»˜é‡‘é¢æ ¡éªŒï¼ˆé˜²ç¯¡æ”¹ï¼‰

**å¯é æ€§**:
- Webhooké‡è¯•æœºåˆ¶ï¼ˆæ”¯ä»˜æä¾›å•†ä¾§ï¼‰
- è®¢å•çŠ¶æ€ä¸»åŠ¨æŸ¥è¯¢ï¼ˆè¡¥å¿æœºåˆ¶ï¼‰
- å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆè§£è€¦æ”¯ä»˜å’Œé…ç½®ï¼‰
- å¤±è´¥å‘Šè­¦å’Œäººå·¥ä»‹å…¥

**å¤šæä¾›å•†å·®å¼‚å¤„ç†**:
- **å¾®ä¿¡æ”¯ä»˜**: è¿”å›QRç URLï¼Œç”¨æˆ·æ‰«ç æ”¯ä»˜
- **Stripe**: è¿”å›Checkouté¡µé¢URLï¼Œè·³è½¬æ”¯ä»˜
- **æ”¯ä»˜å®**: è¿”å›QRç URLæˆ–è°ƒèµ·APPæ”¯ä»˜

ç»Ÿä¸€æ¥å£å±è”½å·®å¼‚ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¿”å›ç±»å‹å±•ç¤ºä¸åŒUI

#### æ”¯ä»˜æä¾›å•†èƒ½åŠ›æ˜ å°„

| èƒ½åŠ› | å¾®ä¿¡æ”¯ä»˜ | Stripe | æ”¯ä»˜å® |
|------|---------|--------|--------|
| QRç æ”¯ä»˜ | âœ… | âŒ | âœ… |
| ç½‘é¡µè·³è½¬ | âŒ | âœ… | âœ… |
| APPå†…æ”¯ä»˜ | âœ… | âœ… | âœ… |
| è®¢é˜…æ¨¡å¼ | âŒ (æ‰‹åŠ¨) | âœ… | âŒ (æ‰‹åŠ¨) |
| Webhookå›è°ƒ | âœ… | âœ… | âœ… |
| ç­¾åéªŒè¯ | âœ… | âœ… | âœ… |

**Note**: ä¸­å›½å¸‚åœºæš‚ä¸æ”¯æŒè‡ªåŠ¨è®¢é˜…ç»­è´¹ï¼Œéœ€è¦æ¯æœˆæ‰‹åŠ¨æ”¯ä»˜ï¼ˆæ”¯ä»˜ç›‘ç®¡é™åˆ¶ï¼‰

#### è®¾è®¡ä¼˜åŠ¿

- âœ… **å¤šå¸‚åœºæ”¯æŒ**ï¼šä¸­å›½å¸‚åœºï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰ï¼Œå›½é™…å¸‚åœºï¼ˆStripeï¼‰
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°æ”¯ä»˜æ–¹å¼æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘
- âœ… **ç»Ÿä¸€å¤„ç†**ï¼šWebhookå›è°ƒæ ‡å‡†åŒ–å¤„ç†
- âœ… **å°è£…ç»†èŠ‚**ï¼šæ”¯ä»˜æä¾›å•†ç‰¹å®šé€»è¾‘å°è£…åœ¨å„è‡ªå®ç°ä¸­
- âœ… **çµæ´»åˆ‡æ¢**ï¼šå¯æ ¹æ®ç”¨æˆ·åœ°åŒºè‡ªåŠ¨é€‰æ‹©æ”¯ä»˜æ–¹å¼

---

## 7. å®‰å…¨è€ƒè™‘

### 7.1 è®¤è¯ï¼ˆåŸºäº Logtoï¼‰

**ç­–ç•¥**: åŸºäº Logto çš„ OIDC/OAuth 2.0 æ ‡å‡†è®¤è¯

**æ¶æ„**:
```
å®¢æˆ·ç«¯ï¼ˆExpo/React Nativeï¼‰ â”€â”€â”€â”€â”€â”
                              â”‚ OIDC/OAuth 2.0
                              â–¼
                        Logto Service
                              â”‚
                              â–¼
                    VibeBox åç«¯ï¼ˆNext.jsï¼‰
                              â”‚
                              â–¼
                    Happy Server é›†æˆ
```

**æ ¸å¿ƒç‰¹æ€§**:
- **æ ‡å‡†åè®®**: OIDC/OAuth 2.0ï¼Œé¿å…ä¾›åº”å•†é”å®š
- **ç§»åŠ¨ä¼˜å…ˆ**: åŸç”Ÿ Expo SDK (`@logto/rn`)ï¼Œé WebView
- **å®‰å…¨å­˜å‚¨**: expo-secure-store å­˜å‚¨ token
- **ç¤¾äº¤ç™»å½•**: Google, Apple, GitHub ç­‰
- **ä¼ä¸šçº§åŠŸèƒ½**: RBAC, MFA, å¤šç§Ÿæˆ·æ”¯æŒ
- **è®¢é˜…æ˜ å°„**: Logto è§’è‰²æ˜ å°„åˆ°è®¢é˜…ç­‰çº§ï¼ˆfree/pro/enterpriseï¼‰

**å®ç°ç»†èŠ‚**:
- Token éªŒè¯: JWT éªŒè¯ï¼Œä½¿ç”¨ Logto JWKS endpoint
- ä¼šè¯ç®¡ç†: JWT access token + refresh token
- Token è¿‡æœŸ: Access token 1å°æ—¶ï¼Œrefresh token 14å¤©
- CSRF ä¿æŠ¤: Next.js å†…ç½® + OIDC state parameter
- RBAC è§’è‰²:
  - `free`: åŸºç¡€è®¢é˜…ç”¨æˆ·
  - `pro`: ä¸“ä¸šè®¢é˜…ç”¨æˆ·
  - `enterprise`: ä¼ä¸šè®¢é˜…ç”¨æˆ·
  - `admin`: å¹³å°ç®¡ç†å‘˜

**ä¸ Happy Server é›†æˆ**:
- VibeBox å¹³å°ç”¨æˆ·ï¼ˆLogto IDï¼‰â†’ Happy è´¦æˆ·æ˜ å°„å­˜å‚¨åœ¨æ•°æ®åº“
- ç”¨æˆ·è®¢é˜…æ—¶ï¼Œåç«¯è‡ªåŠ¨åˆ›å»º Happy è´¦æˆ·ï¼ˆè°ƒç”¨ `/v1/auth`ï¼‰
- å®¢æˆ·ç«¯ä½¿ç”¨ Happy credentials ç›´æ¥è¿æ¥ Happy Server

**å‚è€ƒæ–‡æ¡£**: è¯¦è§ [ADR 002: Authentication Solution](../decisions/002-authentication-solution.md)

### 7.2 API å®‰å…¨

- æ‰€æœ‰ API è·¯ç”±ç”±ä¸­é—´ä»¶ä¿æŠ¤
- é™æµ: æ¯ IP 100 æ¬¡è¯·æ±‚/åˆ†é’Ÿ
- è¾“å…¥éªŒè¯: Zod schemas
- SQL æ³¨å…¥é˜²æŠ¤: å‚æ•°åŒ–æŸ¥è¯¢ (Prisma)

### 7.3 å¯†é’¥ç®¡ç†

**æ•æ„Ÿæ•°æ®**:
- ç”¨æˆ·å¯†ç : bcrypt hash
- Root å¯†ç : AES-256 åŠ å¯†
- Happy secrets: é™æ€åŠ å¯†
- æ”¯ä»˜æä¾›å•† API å¯†é’¥: ç¯å¢ƒå˜é‡

**ç¯å¢ƒå˜é‡**:
```env
DATABASE_URL=
HAPPY_SERVER_URL=

# Payment Providers
WECHAT_PAY_MCHID=
WECHAT_PAY_APPID=
WECHAT_PAY_API_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
ALIPAY_APP_ID=
ALIPAY_PRIVATE_KEY=

# Security
ENCRYPTION_KEY=
SESSION_SECRET=
```

---

## 8. æŠ€æœ¯å†³ç­–æ€»ç»“

| å†³ç­– | é€‰æ‹© | ç†ç”± |
|----------|--------|-----------|
| **å®¢æˆ·ç«¯æ¡†æ¶** | Expo + React Native | ç§»åŠ¨ä¼˜å…ˆï¼Œè·¨å¹³å°ï¼Œå·²éªŒè¯ ([ADR 001](../decisions/001-client-technology-stack.md)) |
| **åç«¯æ¡†æ¶** | Next.js 15 | API Routesï¼ŒTypeScriptï¼ŒReact ç”Ÿæ€ |
| **æ•°æ®åº“** | PostgreSQL | å¯é ï¼Œæˆç†Ÿï¼Œè‰¯å¥½çš„ Prisma æ”¯æŒ |
| **è®¤è¯ (MVP)** | ç”¨æˆ·å + å¯†ç  | ç®€å•ï¼Œå¿«é€Ÿå®ç°ï¼Œå¯åç»­è¿ç§»åˆ° Logto |
| **Happy é›†æˆ** | é›¶ä¿®æ”¹ | ä½¿ç”¨å®˜æ–¹ APIï¼Œæ— éœ€ fork |
| **æ”¯ä»˜** | æ’ä»¶åŒ– (å¾®ä¿¡/Stripe/æ”¯ä»˜å®) | å¤šå¸‚åœºæ”¯æŒï¼Œä¸­å›½ä¼˜å…ˆï¼ˆå¾®ä¿¡ï¼‰ï¼Œå›½é™…åç»­ï¼ˆStripeï¼‰ |
| **éƒ¨ç½²** | TBD | Docker + äº‘æœåŠ¡å•† (AWS/GCP/DigitalOcean) |

---

## 9. æ¶æ„è€ƒè™‘

### 9.1 èµ„æºæ± ç®¡ç†æ¶æ„

**æ ¸å¿ƒç†å¿µ**ï¼š
VibeBox æ¶æ„é‡‡ç”¨**èµ„æºæ± é¢„é…ç½®**ç­–ç•¥ï¼Œä¸šåŠ¡å±‚åªè´Ÿè´£**èµ„æºåˆ†é…**ï¼Œä¸æ¶‰åŠ**èµ„æºåˆ›å»º**ã€‚è¿™ç§åˆ†ç¦»ç®€åŒ–äº†ç³»ç»Ÿå¤æ‚åº¦ï¼ŒåŠ é€Ÿäº†ç”¨æˆ·ä½“éªŒã€‚

#### ä¸¤ä¸ªèµ„æºæ± 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  èµ„æºæ± ç®¡ç†                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ğŸ“¦ æœåŠ¡å™¨èµ„æºæ±  (Server Pool)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ é¢„é…ç½®çš„ VibeBox æœåŠ¡å™¨å®ä¾‹                     â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚ æ¯ä¸ªæœåŠ¡å™¨åŒ…å«ï¼š                                â”‚     â”‚
â”‚  â”‚  âœ… å·²å®‰è£… Happy å®ˆæŠ¤è¿›ç¨‹                       â”‚     â”‚
â”‚  â”‚  âœ… å·²å®‰è£… Claude Code                         â”‚     â”‚
â”‚  â”‚  âœ… å·²é…ç½®å¼€å‘ç¯å¢ƒ (git, node, python...)      â”‚     â”‚
â”‚  â”‚  âœ… å·²å‘ Happy Server æ³¨å†Œ                     â”‚     â”‚
â”‚  â”‚  âœ… éšæ—¶å¯åˆ†é…ç»™ç”¨æˆ·                            â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚ çŠ¶æ€ï¼šavailable | allocated | maintenance     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                         â”‚
â”‚  ğŸ”‘ API Key èµ„æºæ±  (API Key Pool)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ é¢„é…ç½®çš„ Claude API Keys                       â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚ æ¯ä¸ª API Key åŒ…å«ï¼š                            â”‚     â”‚
â”‚  â”‚  âœ… Claude API Key                            â”‚     â”‚
â”‚  â”‚  âœ… é¢„è®¾é…é¢ (å¦‚ $20/æœˆ)                       â”‚     â”‚
â”‚  â”‚  âœ… ä½¿ç”¨ç»Ÿè®¡                                   â”‚     â”‚
â”‚  â”‚  âœ… éšæ—¶å¯åˆ†é…ç»™ç”¨æˆ·                            â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚ çŠ¶æ€ï¼šavailable | allocated | suspended       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¶æ„èŒè´£åˆ’åˆ†

**VibeBox åç«¯ï¼ˆäº§å“å±‚ï¼‰**ï¼š
- âœ… ä»èµ„æºæ± åˆ†é…èµ„æºï¼ˆSELECT available resourceï¼‰
- âœ… ç»‘å®šèµ„æºåˆ°ç”¨æˆ·è´¦æˆ·
- âœ… æ›´æ–°èµ„æºçŠ¶æ€ï¼ˆallocated/availableï¼‰
- âœ… ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- âœ… èµ„æºå›æ”¶ï¼ˆç”¨æˆ·å–æ¶ˆè®¢é˜…æ—¶å½’è¿˜æ± ï¼‰

**èµ„æºæ± ç®¡ç†ï¼ˆè¿ç»´å±‚ï¼‰**ï¼š
- âŒ VibeBox æ¶æ„ä¸å…³å¿ƒæ­¤éƒ¨åˆ†
- åˆ›å»ºæ–°æœåŠ¡å™¨å®ä¾‹
- é…ç½® Happy ç¯å¢ƒ
- è¡¥å……èµ„æºæ± åº“å­˜
- æœåŠ¡å™¨ç»´æŠ¤å’Œå‡çº§
- API Key é‡‡è´­å’Œé…é¢ç®¡ç†

#### åˆ†é…æµç¨‹

```
æ”¯ä»˜æˆåŠŸ â†’ ä»èµ„æºæ± åˆ†é…
    â”‚
    â”œâ”€> 1. æŸ¥è¯¢å¯ç”¨æœåŠ¡å™¨ (status = 'available')
    â”‚   SELECT * FROM ServerPool WHERE status = 'available' LIMIT 1
    â”‚
    â”œâ”€> 2. æŸ¥è¯¢å¯ç”¨ API Key (status = 'available')
    â”‚   SELECT * FROM ApiKeyPool WHERE status = 'available' LIMIT 1
    â”‚
    â”œâ”€> 3. æ›´æ–°çŠ¶æ€ä¸ºå·²åˆ†é…
    â”‚   UPDATE status = 'allocated', userId = xxx
    â”‚
    â””â”€> 4. åˆ›å»º VibeBox è®°å½•
        INSERT INTO VibeBox (userId, serverPoolId, apiKeyId, status = 'running')

æ€»è€—æ—¶ï¼š<30ç§’ï¼ˆæ•°æ®åº“æ“ä½œ + ç»‘å®šï¼‰
```

#### å›æ”¶æµç¨‹

```
è®¢é˜…è¿‡æœŸ/å–æ¶ˆ â†’ å½’è¿˜èµ„æºåˆ°æ± 
    â”‚
    â”œâ”€> 1. æ¸…ç†ç”¨æˆ·æ•°æ®ï¼ˆå¯é€‰ï¼‰
    â”‚   SSH ç™»å½•æœåŠ¡å™¨ï¼Œåˆ é™¤ç”¨æˆ·æ–‡ä»¶
    â”‚
    â”œâ”€> 2. é‡ç½®æœåŠ¡å™¨çŠ¶æ€
    â”‚   æ¢å¤åˆ°åˆå§‹é…ç½®ï¼ˆæˆ–ä¿ç•™ï¼Œå–å†³äºç­–ç•¥ï¼‰
    â”‚
    â”œâ”€> 3. å½’è¿˜åˆ°èµ„æºæ± 
    â”‚   UPDATE ServerPool SET status = 'available', userId = NULL
    â”‚   UPDATE ApiKeyPool SET status = 'available', userId = NULL
    â”‚
    â””â”€> 4. æ›´æ–° VibeBox çŠ¶æ€
        UPDATE VibeBox SET status = 'terminated'

èµ„æºå¯é‡å¤åˆ©ç”¨
```

#### èµ„æºæ± ç»´æŠ¤ç­–ç•¥

**å‰æœŸï¼ˆMVPï¼‰**ï¼š
- æ‰‹åŠ¨ç»´æŠ¤èµ„æºæ± 
- æå‰åˆ›å»º 10-20 ä¸ªæœåŠ¡å™¨å®ä¾‹
- æå‰é‡‡è´­ 10-20 ä¸ª Claude API Keys
- æ‰‹åŠ¨ç›‘æ§åº“å­˜ï¼Œåº“å­˜ä¸è¶³æ—¶æ‰‹åŠ¨è¡¥å……

**æœªæ¥ï¼ˆè‡ªåŠ¨åŒ–ï¼‰**ï¼š
- è‡ªåŠ¨ç›‘æ§åº“å­˜æ°´ä½ï¼ˆå¦‚ï¼šå¯ç”¨èµ„æº < 5 ä¸ªæ—¶å‘Šè­¦ï¼‰
- è‡ªåŠ¨æ‰©å±•èµ„æºæ± ï¼ˆäº‘æœåŠ¡å•† API è‡ªåŠ¨åˆ›å»ºå®ä¾‹ï¼‰
- è‡ªåŠ¨é…ç½®æ–°æœåŠ¡å™¨ï¼ˆAnsible/Terraformï¼‰
- è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»

#### æ‰˜ç®¡é€‰é¡¹

**äº‘æœåŠ¡å•†**:
- **ä¸­å›½å¸‚åœº**: é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼ˆä½å»¶è¿Ÿï¼Œæœ¬åœ°åˆè§„ï¼‰
- **å›½é™…å¸‚åœº**: AWS EC2, DigitalOcean, Vultr, Linode

**è€ƒè™‘å› ç´ **:
- æˆæœ¬: æŒ‰éœ€å®ä¾‹ vs é¢„ç•™å®ä¾‹
- å»¶è¿Ÿ: ç”¨æˆ·æ‰€åœ¨åœ°åŒº
- åŒºåŸŸå¯ç”¨æ€§: å¤šåŒºåŸŸéƒ¨ç½²
- Happy Server å¯è®¿é—®æ€§: ç¡®ä¿èƒ½è¿æ¥åˆ° Happy Server

#### æ•°æ®æ¨¡å‹ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åœ¨æ•°æ®åº“ä¸­è·Ÿè¸ªèµ„æºæ± çŠ¶æ€ï¼Œå¯ä»¥æ·»åŠ ä»¥ä¸‹è¡¨ï¼š

```prisma
model ServerPool {
  id            String   @id @default(cuid())
  ip            String   @unique
  sshPort       Int      @default(22)
  rootPassword  String   // Encrypted

  // Cloud provider info
  provider      String   // "aws" | "aliyun" | "digitalocean"
  region        String   // "us-east-1" | "cn-hangzhou"
  instanceId    String?  // Cloud provider instance ID

  // Status
  status        String   // "available" | "allocated" | "maintenance"
  userId        String?  // åˆ†é…ç»™å“ªä¸ªç”¨æˆ·
  allocatedAt   DateTime?

  // Happy integration
  happyConfigured Boolean @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([userId])
}

model ApiKeyPool {
  id            String   @id @default(cuid())
  apiKey        String   @unique  // Encrypted

  // Quota
  monthlyQuota  Int      // In dollars (e.g., 20 = $20/month)
  usedQuota     Int      @default(0)

  // Status
  status        String   // "available" | "allocated" | "suspended"
  userId        String?  // åˆ†é…ç»™å“ªä¸ªç”¨æˆ·
  allocatedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([userId])
}
```

#### å…³é”®ä¼˜åŠ¿

- âœ… **ç®€åŒ–ä¸šåŠ¡é€»è¾‘**: æ¶æ„å±‚åªéœ€åˆ†é…èµ„æºï¼Œä¸æ¶‰åŠåˆ›å»ºå’Œé…ç½®
- âœ… **æé€Ÿä½“éªŒ**: ç”¨æˆ·æ”¯ä»˜å <30ç§’ è·å¾—å¯ç”¨ Box
- âœ… **è§£è€¦å…³æ³¨ç‚¹**: èµ„æºåˆ›å»ºï¼ˆè¿ç»´ï¼‰å’Œèµ„æºåˆ†é…ï¼ˆä¸šåŠ¡ï¼‰åˆ†ç¦»
- âœ… **å‰æœŸå¿«é€ŸéªŒè¯**: æ‰‹åŠ¨ç»´æŠ¤èµ„æºæ± ï¼Œå¿«é€Ÿä¸Šçº¿ MVP
- âœ… **åæœŸå¯è‡ªåŠ¨åŒ–**: èµ„æºæ± ç®¡ç†å¯ç‹¬ç«‹æ¼”è¿›å’Œè‡ªåŠ¨åŒ–

### 9.2 å¤šåŒºåŸŸå’Œå¸‚åœºæ”¯æŒ

**åŒºåŸŸéƒ¨ç½²**:
- **ä¸­å›½å¸‚åœº**: éƒ¨ç½²åœ¨é˜¿é‡Œäº‘/è…¾è®¯äº‘ä»¥è·å¾—æ›´å¥½çš„è®¿é—®
  - è€ƒè™‘ Happy Server å»¶è¿Ÿå’Œå¯è®¿é—®æ€§
  - å¯èƒ½éœ€è¦è‡ªæ‰˜ç®¡ Happy Server é•œåƒ
- **å›½é™…å¸‚åœº**: AWS / GCP / DigitalOcean
  - åˆ†å¸ƒå¼éƒ¨ç½²å®ç°å…¨çƒä½å»¶è¿Ÿè®¿é—®

**æ•°æ®ä¸»æƒ**:
- ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨å…¶æ³¨å†Œçš„åŒºåŸŸ
- è·¨åŒºåŸŸå¤åˆ¶è€ƒè™‘
- éµå®ˆå½“åœ°æ³•è§„

### 9.3 å¯æ‰©å±•æ€§è®¾è®¡

**æ•°æ®åº“æ‰©å±•**:
- è¿æ¥æ±  (PgBouncer)
- ç”¨äºæŠ¥å‘Šå’Œåˆ†æçš„åªè¯»å‰¯æœ¬
- å¤§è¡¨çš„åˆ†åŒºç­–ç•¥ï¼ˆè®¢é˜…ã€vibeboxesï¼‰

**Happy Server å¯æ‰©å±•æ€§**:
- å®˜æ–¹ Happy Server å®¹é‡é™åˆ¶
- å¯èƒ½éœ€è¦å¤šä¸ª Happy Server å®ä¾‹
- Happy è´¦æˆ·çš„è´Ÿè½½å‡è¡¡ç­–ç•¥

**VibeBox èµ„æºé™åˆ¶**:
- æ¯ç”¨æˆ·èµ„æºé…é¢
- å…¬å¹³è°ƒåº¦å’Œèµ„æºåˆ†é…
- æº¢å‡ºå¤„ç†ç­–ç•¥

### 9.4 ç›‘æ§å’Œå¯è§‚æµ‹æ€§

**å…³é”®æŒ‡æ ‡**:
- ç³»ç»Ÿå¥åº·: API å»¶è¿Ÿã€é”™è¯¯ç‡ã€æ•°æ®åº“æ€§èƒ½
- ä¸šåŠ¡æŒ‡æ ‡: æ´»è·ƒè®¢é˜…ã€VibeBox åˆ©ç”¨ç‡ã€API é…é¢ä½¿ç”¨
- ç”¨æˆ·ä½“éªŒ: å®¢æˆ·ç«¯åº”ç”¨æ€§èƒ½ã€è¿æ¥æˆåŠŸç‡

**å·¥å…·è€ƒè™‘**:
- é”™è¯¯è·Ÿè¸ª: Sentry, Bugsnag æˆ–ç±»ä¼¼å·¥å…·
- æ—¥å¿—: ç»“æ„åŒ–æ—¥å¿— (JSON)ï¼Œé›†ä¸­èšåˆ
- æŒ‡æ ‡: Prometheus + Grafanaï¼Œæˆ–äº‘æœåŠ¡å•†æ–¹æ¡ˆ
- å‘Šè­¦: å…³é”®æ•…éšœã€æ”¯ä»˜é—®é¢˜ã€èµ„æºè€—å°½

---

## é™„å½•A: APIç«¯ç‚¹å‚è€ƒ

> æœ¬èŠ‚æä¾›ç®€åŒ–çš„APIç«¯ç‚¹åˆ—è¡¨ä¾›å¿«é€Ÿå‚è€ƒã€‚è¯¦ç»†çš„æ¥å£è®¾è®¡åº”åœ¨åç»­çš„"APIè§„èŒƒæ–‡æ¡£"ä¸­å®šä¹‰ã€‚

### è®¤è¯ç›¸å…³

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” | è¯´æ˜ |
|------|------|------|------|
| `/api/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ | åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ· |
| `/api/auth/login` | POST | ç”¨æˆ·ç™»å½• | è¿”å›session token |
| `/api/auth/logout` | POST | ç”¨æˆ·ç™»å‡º | æ¸…é™¤session |
| `/api/auth/session` | GET | è·å–å½“å‰session | æ£€æŸ¥ç™»å½•çŠ¶æ€ |

### è®¢é˜…ç›¸å…³

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” | è¯´æ˜ |
|------|------|------|------|
| `/api/subscriptions/plans` | GET | è·å–è®¢é˜…è®¡åˆ’ | è¿”å›æ‰€æœ‰å¯ç”¨è®¡åˆ’ |
| `/api/subscriptions/checkout` | POST | åˆ›å»ºæ”¯ä»˜è®¢å• | è¿”å›æ”¯ä»˜ä¿¡æ¯ï¼ˆURL/QRç ï¼‰ |
| `/api/subscriptions/webhook/:provider` | POST | æ”¯ä»˜å›è°ƒ | æ¥æ”¶æ”¯ä»˜æˆåŠŸé€šçŸ¥ |

### VibeBoxç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” | è¯´æ˜ |
|------|------|------|------|
| `/api/vibeboxes` | GET | è·å–VibeBoxåˆ—è¡¨ | è¿”å›ç”¨æˆ·çš„æ‰€æœ‰VibeBox |
| `/api/vibeboxes/:id` | GET | è·å–VibeBoxè¯¦æƒ… | åŒ…å«è¿æ¥ä¿¡æ¯ï¼ˆtoken/secretï¼‰ |
| `/api/vibeboxes/:id/control` | POST | æ§åˆ¶VibeBox | å¯åŠ¨/åœæ­¢/é‡å¯æ“ä½œ |

### å†…éƒ¨APIï¼ˆç³»ç»Ÿå†…éƒ¨è°ƒç”¨ï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” | è¯´æ˜ |
|------|------|------|------|
| `/api/admin/provision` | POST | é…ç½®VibeBox | æ”¯ä»˜æˆåŠŸåè§¦å‘ |

**æ³¨æ„**:
- æ‰€æœ‰APIï¼ˆé™¤authç›¸å…³ï¼‰éœ€è¦è®¤è¯ï¼ˆBearer tokenæˆ–Session cookieï¼‰
- è¯¦ç»†çš„Request/Responseæ ¼å¼åº”åœ¨åç»­çš„"APIè§„èŒƒæ–‡æ¡£"ä¸­å®šä¹‰
- æœ¬è¡¨ä»…ä¾›æ¶æ„å±‚é¢å¿«é€Ÿå‚è€ƒ

---

**æ–‡æ¡£å†å²**:
- 2025-10-22: åˆå§‹è‰ç¨¿åˆ›å»º
- 2025-10-22: ç§»é™¤å®æ–½é˜¶æ®µï¼Œä¸“æ³¨æ¶æ„
- 2025-10-22: **é‡å¤§ä¿®æ­£** - ç§»é™¤ WebView åµŒå…¥çš„è¯¯è§£ï¼Œæ¾„æ¸… VibeBox å®¢æˆ·ç«¯æ˜¯ happy-client çš„ç›´æ¥ forkï¼ˆéåŒ…è£…å™¨/å¤–å£³ï¼‰
- 2025-10-22: **é‡å¤§é‡æ„** - ä»ä»£ç å¯¼å‘æ”¹ä¸ºæ¶æ„å¯¼å‘é£æ ¼ï¼šç”¨æµç¨‹å›¾ã€æ—¶åºå›¾å’Œæ¶æ„æè¿°æ›¿ä»£ API å®šä¹‰å’Œä»£ç ç¤ºä¾‹
- 2025-10-22: **è¯­è¨€ç»Ÿä¸€** - å°†æ–‡æ¡£ä»ä¸­è‹±æ··æ‚ç»Ÿä¸€ä¸ºä¸­æ–‡
- 2025-10-23: **P0 ä¿®å¤** (v1.1) - æ›´æ–°è®¤è¯æ–¹æ¡ˆä¸º Logtoï¼ˆä¸ ADR 002 ä¸€è‡´ï¼Œå·²é›†æˆï¼‰ï¼Œæ¾„æ¸…é›¶ä¿®æ”¹åŸåˆ™çš„å…·ä½“èŒƒå›´ï¼ˆä»…é€‚ç”¨äº happy-server/cliï¼Œä¸åŒ…æ‹¬å®¢æˆ·ç«¯å®šåˆ¶ï¼‰
- 2025-10-27: **é‡å¤§æ¶æ„è°ƒæ•´** (v1.2) - èµ„æºæ± æ¶æ„
  - ç¡®è®¤ä½¿ç”¨é¢„é…ç½®èµ„æºæ± ç­–ç•¥ï¼ˆæœåŠ¡å™¨æ±  + API Key æ± ï¼‰
  - å»æ‰ SSH è‡ªåŠ¨åŒ–é…ç½®é€»è¾‘ï¼ˆèµ„æºå·²é¢„é…ç½®ï¼‰
  - ç®€åŒ–çŠ¶æ€æœºï¼ˆå»æ‰ provisioning/configuring çŠ¶æ€ï¼‰
  - ç¼©çŸ­é…ç½®æ—¶é—´ï¼ˆ2-5åˆ†é’Ÿ â†’ <30ç§’ï¼‰
  - æ˜ç¡®æ¶æ„èŒè´£ï¼šä¸šåŠ¡å±‚è´Ÿè´£åˆ†é…ï¼Œè¿ç»´å±‚è´Ÿè´£åˆ›å»º
  - æ›´æ–°æ•°æ®æ¨¡å‹ï¼ˆæ·»åŠ èµ„æºæ± ç›¸å…³å­—æ®µï¼‰
  - å®Œæ•´é‡å†™ Section 9.1 èµ„æºæ± ç®¡ç†æ¶æ„
